// Access Codes Management Service
import {
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  getDocs,
  getDoc,
  query,
  where,
  orderBy,
  serverTimestamp,
} from 'firebase/firestore';
import { db } from './config';
import { cleanFirebaseData } from '../utils/firebaseUtils';
import { isDateExpired } from '../utils/dateUtils';

// ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ ูุฑูุฒ ูุตูู (ููุฅุฏุงุฑุฉ ููุท)
export const resetDeviceForAccessCode = async codeId => {
  try {
    console.log('๐ ุจุฏุก ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ ููุฑูุฒ:', codeId);

    const codeRef = doc(db, 'accessCodes', codeId);

    // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุทุงูุจ ุฃููุงู
    const codeDoc = await getDoc(codeRef);
    if (!codeDoc.exists()) {
      return {
        success: false,
        error: 'ุฑูุฒ ุงููุตูู ุบูุฑ ููุฌูุฏ',
      };
    }

    const codeData = codeDoc.data();

    // ุฅูุดุงุก session token ุฌุฏูุฏ ูุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู
    const newSessionToken = `reset_${Date.now()}_${Math.random()
      .toString(36)
      .substr(2, 12)}`;

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูุฑูุฒ
    await updateDoc(codeRef, {
      deviceId: null,
      deviceInfo: null,
      lastLoginAt: null,
      sessionToken: newSessionToken, // ุฅุถุงูุฉ session token ุฌุฏูุฏ
      sessionExpiry: new Date(Date.now() + 24 * 60 * 60 * 1000), // ุงูุชูุงุก ุงูุตูุงุญูุฉ ุฎูุงู 24 ุณุงุนุฉ
      forceReauth: true, // ุนูุงูุฉ ูุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุงููุตุงุฏูุฉ
      resetAt: serverTimestamp(), // ููุช ุฅุนุงุฏุฉ ุงูุชุนููู
      resetCount: (codeData.resetCount || 0) + 1, // ุนุฏุงุฏ ูุฑุงุช ุฅุนุงุฏุฉ ุงูุชุนููู
    });

    // ุฅุฑุณุงู ุฅุดุงุฑุฉ ุฅุนุงุฏุฉ ุชุนููู ุนุจุฑ localStorage (ููุทูุงุจ ุงููุชุตููู ุญุงููุงู)
    try {
      const resetSignal = {
        studentId: codeId,
        timestamp: Date.now(),
        message: 'ุชู ุฅุนุงุฏุฉ ุชุนููู ุญุณุงุจู ูู ูุจู ุงูุฅุฏุงุฑุฉ',
        resetDeviceId: true, // ุฅุดุงุฑุฉ ูุฅุนุงุฏุฉ ุชุนููู ูุนุฑู ุงูุฌูุงุฒ ุฃูุถุงู
      };
      localStorage.setItem('admin_reset_signal', JSON.stringify(resetSignal));

      // ุฅุฒุงูุฉ ุงูุฅุดุงุฑุฉ ุจุนุฏ ุซุงููุฉ ูุงุญุฏุฉ
      setTimeout(() => {
        localStorage.removeItem('admin_reset_signal');
      }, 1000);
    } catch (storageError) {
      console.warn('ุชุนุฐุฑ ุฅุฑุณุงู ุฅุดุงุฑุฉ ุฅุนุงุฏุฉ ุงูุชุนููู:', storageError);
    }

    // ุชุณุฌูู ุงูุนูููุฉ ูู ุณุฌู ุงูุฃูุงู
    try {
      const { logSuspiciousActivity } = await import(
        '../utils/securityMonitor'
      );
      await logSuspiciousActivity({
        type: 'admin_device_reset',
        description: `ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ ููุทุงูุจ ${codeData.studentName} ูู ูุจู ุงูุฅุฏุงุฑุฉ`,
        userId: codeId,
        severity: 'medium',
        metadata: {
          studentName: codeData.studentName,
          previousDeviceId: codeData.deviceId,
          resetCount: (codeData.resetCount || 0) + 1,
        },
      });
    } catch (logError) {
      console.warn('ุชุนุฐุฑ ุชุณุฌูู ุนูููุฉ ุฅุนุงุฏุฉ ุงูุชุนููู:', logError);
    }

    console.log('โ ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ ุจูุฌุงุญ');
    return {
      success: true,
      message:
        'ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ ุจูุฌุงุญ. ุชู ุฅุบูุงู ุฌููุน ุงูุฌูุณุงุช ุงููุดุทุฉ. ูููู ููุทุงูุจ ุงูุขู ุชุณุฌูู ุงูุฏุฎูู ูู ุฌูุงุฒ ุฌุฏูุฏ ููุท.',
    };
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุงุฒ:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุฅูุดุงุก ุฑูุฒ ูุตูู ุฌุฏูุฏ
export const createAccessCode = async studentData => {
  try {
    // ุฅูุดุงุก ุฑูุฒ ูุฑูุฏ
    const accessCode = generateUniqueCode();

    const codeData = {
      code: accessCode,
      studentName: studentData.studentName,
      phoneNumber: studentData.phoneNumber || '',
      parentPhoneNumber: studentData.parentPhoneNumber || '', // ุฑูู ููู ุงูุฃูุฑ
      category: studentData.category || '', // ูุฆุฉ ุงูุทุงูุจ
      allowedSections: studentData.allowedSections || [], // ุงูุฃูุณุงู ุงููุณููุญุฉ
      isActive: true,
      deviceId: null, // ุณูุชู ุชุนูููู ุนูุฏ ุฃูู ุชุณุฌูู ุฏุฎูู
      deviceInfo: null,
      assignedVideos: [], // ูุงุฆูุฉ ูุนุฑูุงุช ุงูููุฏูููุงุช ุงููุฎุตุตุฉ
      loginHistory: [],
      createdAt: serverTimestamp(),
      lastLoginAt: null,
      expiryDate: studentData.expiryDate || null,
      notes: studentData.notes || '',
    };

    const docRef = await addDoc(collection(db, 'accessCodes'), codeData);

    return {
      success: true,
      codeId: docRef.id,
      accessCode: accessCode,
      message: 'ุชู ุฅูุดุงุก ุฑูุฒ ุงููุตูู ุจูุฌุงุญ',
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ุฑูุฒ ุงููุตูู:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุงูุญุตูู ุนูู ุฌููุน ุฑููุฒ ุงููุตูู (ููุฅุฏุงุฑุฉ)
export const getAllAccessCodes = async () => {
  try {
    const q = query(
      collection(db, 'accessCodes'),
      orderBy('createdAt', 'desc')
    );

    const querySnapshot = await getDocs(q);
    const codes = [];

    querySnapshot.forEach(doc => {
      codes.push({
        id: doc.id,
        ...doc.data(),
      });
    });

    return {
      success: true,
      codes: codes,
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฌูุจ ุฑููุฒ ุงููุตูู:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุชุญุฏูุซ ุฑูุฒ ุงููุตูู
export const updateAccessCode = async (codeId, updateData) => {
  try {
    // ุชูุธูู ุงูุจูุงูุงุช ูู ุงูููู null ู undefined
    const cleanedData = cleanFirebaseData(updateData);

    await updateDoc(doc(db, 'accessCodes', codeId), {
      ...cleanedData,
      updatedAt: serverTimestamp(),
    });

    return {
      success: true,
      message: 'ุชู ุชุญุฏูุซ ุฑูุฒ ุงููุตูู ุจูุฌุงุญ',
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ุฑูุฒ ุงููุตูู:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุญุฐู ุฑูุฒ ุงููุตูู
export const deleteAccessCode = async codeId => {
  try {
    await deleteDoc(doc(db, 'accessCodes', codeId));

    return {
      success: true,
      message: 'ุชู ุญุฐู ุฑูุฒ ุงููุตูู ุจูุฌุงุญ',
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุญุฐู ุฑูุฒ ุงููุตูู:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุชุนุทูู/ุชูุนูู ุฑูุฒ ุงููุตูู
export const toggleAccessCode = async (codeId, isActive) => {
  try {
    await updateDoc(doc(db, 'accessCodes', codeId), {
      isActive: isActive,
      updatedAt: serverTimestamp(),
    });

    return {
      success: true,
      message: isActive ? 'ุชู ุชูุนูู ุฑูุฒ ุงููุตูู' : 'ุชู ุชุนุทูู ุฑูุฒ ุงููุตูู',
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุชุบููุฑ ุญุงูุฉ ุฑูุฒ ุงููุตูู:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุงูุชุญูู ูู ุตุญุฉ ุฑูุฒ ุงููุตูู ูุชุณุฌูู ุงูุฏุฎูู
export const validateAccessCode = async (accessCode, deviceInfo) => {
  try {
    console.log('๐ ุจุฏุก ุงูุชุญูู ูู ุฑูุฒ ุงููุตูู:', accessCode);
    console.log('๐ฑ ูุนูููุงุช ุงูุฌูุงุฒ:', deviceInfo);

    // ุงูุจุญุซ ุนู ุฑูุฒ ุงููุตูู
    const q = query(
      collection(db, 'accessCodes'),
      where('code', '==', accessCode)
    );

    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      console.log('โ ุฑูุฒ ุงููุตูู ุบูุฑ ููุฌูุฏ');
      return {
        success: false,
        error: 'ุฑูุฒ ุงููุตูู ุบูุฑ ุตุญูุญ',
      };
    }

    const codeDoc = querySnapshot.docs[0];
    const codeData = codeDoc.data();
    console.log('๐ ุจูุงูุงุช ุฑูุฒ ุงููุตูู:', {
      id: codeDoc.id,
      isActive: codeData.isActive,
      deviceId: codeData.deviceId,
      studentName: codeData.studentName,
    });

    // ุงูุชุญูู ูู ุฃู ุงูุฑูุฒ ูุดุท
    if (!codeData.isActive) {
      console.log('โ ุฑูุฒ ุงููุตูู ูุนุทู');
      return {
        success: false,
        error: 'ุฑูุฒ ุงููุตูู ูุนุทู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ',
      };
    }

    // ุงูุชุญูู ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ
    if (codeData.expiryDate && isDateExpired(codeData.expiryDate)) {
      console.log('โ ุฑูุฒ ุงููุตูู ููุชูู ุงูุตูุงุญูุฉ');
      return {
        success: false,
        error: 'ุฑูุฒ ุงููุตูู ููุชูู ุงูุตูุงุญูุฉ',
      };
    }

    // ุงูุชุญูู ุงูููุญุณู ูู ุงูุฌูุงุฒ
    if (codeData.deviceId) {
      console.log('๐ ุงูุชุญูู ูู ุงูุฌูุงุฒ ุงููุณุฌู:', codeData.deviceId);
      console.log('๐ ุงูุฌูุงุฒ ุงูุญุงูู:', deviceInfo.deviceId);

      if (codeData.deviceId !== deviceInfo.deviceId) {
        console.log('โ ุงูุฌูุงุฒ ูุฎุชูู - ุฑูุถ ุงููุตูู');

        // ุชุณุฌูู ูุญุงููุฉ ุงููุตูู ุงููุดุจููุฉ
        const { logSuspiciousActivity } = await import(
          '../utils/securityMonitor'
        );
        await logSuspiciousActivity({
          type: 'unauthorized_device_access',
          description: `ูุญุงููุฉ ูุตูู ูู ุฌูุงุฒ ุบูุฑ ูุตุฑุญ ุจู ูุฑูุฒ ุงููุตูู ${accessCode}`,
          userId: codeDoc.id,
          deviceId: deviceInfo.deviceId,
          severity: 'high',
          metadata: {
            registeredDevice: codeData.deviceId,
            attemptedDevice: deviceInfo.deviceId,
            studentName: codeData.studentName,
            userAgent: deviceInfo.userAgent,
          },
        });

        return {
          success: false,
          error:
            'ูุฐุง ุงูุฑูุฒ ูุณุฌู ุนูู ุฌูุงุฒ ุขุฎุฑ. ูุง ูููู ุงุณุชุฎุฏุงูู ุนูู ุฃูุซุฑ ูู ุฌูุงุฒ ูุงุญุฏ. ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ุฅุฐุง ููุช ุชุญุชุงุฌ ูุชุบููุฑ ุงูุฌูุงุฒ.',
        };
      }
      console.log('โ ุงูุฌูุงุฒ ูุชุทุงุจู');
    } else {
      console.log('๐ ุชุณุฌูู ุฌูุงุฒ ุฌุฏูุฏ ูุฃูู ูุฑุฉ');
    }

    // ุฅูุดุงุก session token ูุญุณู
    const sessionToken = `session_${Date.now()}_${Math.random()
      .toString(36)
      .substr(2, 12)}_${codeDoc.id.substr(0, 4)}`;

    // ุชุญุฏูุซ ุจูุงูุงุช ุงูุฌูุงุฒ ูุขุฎุฑ ุชุณุฌูู ุฏุฎูู ูุน ูุนูููุงุช ุฅุถุงููุฉ
    const updateData = {
      deviceId: deviceInfo.deviceId,
      deviceInfo: {
        ...deviceInfo,
        lastLoginIP: await getClientIP(),
        registrationTime: codeData.deviceId
          ? codeData.deviceInfo?.registrationTime
          : serverTimestamp(),
      },
      lastLoginAt: serverTimestamp(),
      sessionToken: sessionToken,
      sessionExpiry: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 ุณุงุนุฉ
      forceReauth: false, // ุฅุฒุงูุฉ ุนูุงูุฉ ุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุงููุตุงุฏูุฉ
      loginCount: (codeData.loginCount || 0) + 1, // ุนุฏุงุฏ ูุฑุงุช ุชุณุฌูู ุงูุฏุฎูู
    };

    await updateDoc(doc(db, 'accessCodes', codeDoc.id), updateData);
    console.log('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุฌูุงุฒ ูุงูุฌูุณุฉ');

    // ุฅุฑุฌุงุน ุจูุงูุงุช ุงูุทุงูุจ ูุน session token
    const studentData = {
      id: codeDoc.id,
      ...codeData,
      sessionToken: sessionToken,
      deviceId: deviceInfo.deviceId,
      lastLoginAt: new Date(),
      loginCount: updateData.loginCount,
    };

    console.log('โ ุชู ุงูุชุญูู ูู ุฑูุฒ ุงููุตูู ุจูุฌุงุญ');
    return {
      success: true,
      studentData: studentData,
    };
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุฑูุฒ ุงููุตูู:', error);
    return {
      success: false,
      error: 'ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญูู ูู ุฑูุฒ ุงููุตูู',
    };
  }
};

// ุชุฎุตูุต ููุฏูููุงุช ูุทุงูุจ
export const assignVideosToStudent = async (codeId, videoIds) => {
  try {
    await updateDoc(doc(db, 'accessCodes', codeId), {
      assignedVideos: videoIds,
      updatedAt: serverTimestamp(),
    });

    return {
      success: true,
      message: 'ุชู ุชุฎุตูุต ุงูููุฏูููุงุช ููุทุงูุจ ุจูุฌุงุญ',
    };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุชุฎุตูุต ุงูููุฏูููุงุช:', error);
    return {
      success: false,
      error: error.message,
    };
  }
};

// ุฅูุดุงุก ุฑูุฒ ูุฑูุฏ
const generateUniqueCode = () => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let result = '';
  for (let i = 0; i < 8; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
};

// ุงูุญุตูู ุนูู IP ุงูุนููู
const getClientIP = async () => {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;
  } catch (error) {
    return 'unknown';
  }
};

// ุงูุชุญูู ูู ุตุญุฉ ุงูุฌูุณุฉ ุงููุดุทุฉ
export const validateActiveSession = async (
  studentId,
  sessionToken,
  deviceId
) => {
  try {
    console.log('๐ ุงูุชุญูู ูู ุตุญุฉ ุงูุฌูุณุฉ:', { studentId, deviceId });

    const studentDoc = await getDoc(doc(db, 'accessCodes', studentId));

    if (!studentDoc.exists()) {
      console.log('โ ุงูุทุงูุจ ุบูุฑ ููุฌูุฏ');
      return { success: false, error: 'ุงูุญุณุงุจ ุบูุฑ ููุฌูุฏ' };
    }

    const studentData = studentDoc.data();

    // ุงูุชุญูู ูู ุญุงูุฉ ุงูุญุณุงุจ
    if (!studentData.isActive) {
      console.log('โ ุงูุญุณุงุจ ูุนุทู');
      return { success: false, error: 'ุชู ุฅููุงู ุญุณุงุจู' };
    }

    // ุงูุชุญูู ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ
    if (studentData.expiryDate && isDateExpired(studentData.expiryDate)) {
      console.log('โ ุงูุชูุช ุตูุงุญูุฉ ุงูุญุณุงุจ');
      return { success: false, error: 'ุงูุชูุช ุตูุงุญูุฉ ุญุณุงุจู' };
    }

    // ุงูุชุญูู ูู ุงูุฌูุงุฒ
    if (studentData.deviceId !== deviceId) {
      console.log('โ ุงูุฌูุงุฒ ูุฎุชูู');

      // ุชุณุฌูู ูุญุงููุฉ ุงููุตูู ุงููุดุจููุฉ
      const { logSuspiciousActivity } = await import(
        '../utils/securityMonitor'
      );
      await logSuspiciousActivity({
        type: 'session_hijack_attempt',
        description: `ูุญุงููุฉ ุงุฎุชุทุงู ุฌูุณุฉ ูู ุฌูุงุฒ ูุฎุชูู`,
        userId: studentId,
        deviceId: deviceId,
        severity: 'critical',
        metadata: {
          registeredDevice: studentData.deviceId,
          attemptedDevice: deviceId,
          sessionToken: sessionToken,
        },
      });

      return { success: false, error: 'ุชู ุงูุชุดุงู ูุดุงุท ูุดุจูู' };
    }

    // ุงูุชุญูู ูู session token
    if (studentData.sessionToken !== sessionToken) {
      console.log('โ session token ูุฎุชูู');
      return { success: false, error: 'ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ' };
    }

    // ุงูุชุญูู ูู ุงูุชูุงุก ุตูุงุญูุฉ ุงูุฌูุณุฉ
    if (
      studentData.sessionExpiry &&
      new Date() > studentData.sessionExpiry.toDate()
    ) {
      console.log('โ ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ');
      return { success: false, error: 'ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉ' };
    }

    // ุงูุชุญูู ูู ุนูุงูุฉ ุฅุฌุจุงุฑ ุฅุนุงุฏุฉ ุงููุตุงุฏูุฉ
    if (studentData.forceReauth) {
      console.log('โ ูุทููุจ ุฅุนุงุฏุฉ ูุตุงุฏูุฉ');
      return { success: false, error: 'ูุทููุจ ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ' };
    }

    console.log('โ ุงูุฌูุณุฉ ุตุญูุญุฉ');
    return { success: true, studentData };
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุฌูุณุฉ:', error);
    return { success: false, error: 'ุฎุทุฃ ูู ุงูุชุญูู ูู ุงูุฌูุณุฉ' };
  }
};

// ุฅูุดุงุก ูุนุฑู ูุฑูุฏ ููุญุณู ููุฌูุงุฒ (ุซุงุจุช ูููุณ ุงูุฌูุงุฒ)
export const generateDeviceId = () => {
  try {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุนุฑู ูุญููุธ ูุณุจูุงู
    const savedDeviceId = localStorage.getItem('persistent_device_id');
    if (savedDeviceId) {
      console.log(
        '๐ ุงุณุชุฎุฏุงู ูุนุฑู ุงูุฌูุงุฒ ุงููุญููุธ:',
        savedDeviceId.substring(0, 8) + '...'
      );
      return savedDeviceId;
    }

    // ุฅูุดุงุก Canvas fingerprint ูุญุณู
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 200;
    canvas.height = 50;

    // ุฑุณู ูุต ูุน ุฎุตุงุฆุต ูุฎุชููุฉ
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillStyle = '#f60';
    ctx.fillRect(125, 1, 62, 20);
    ctx.fillStyle = '#069';
    ctx.fillText('Device Security Check ๐', 2, 15);
    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
    ctx.fillText('Security Layer', 4, 35);

    const canvasFingerprint = canvas.toDataURL();

    // ุฌูุน ูุนูููุงุช ุงูุฌูุงุฒ ุงููุญุณูุฉ (ุจุฏูู timestamp ูุชุบูุฑ)
    const deviceInfo = {
      // ูุนูููุงุช ุงูุดุงุดุฉ
      screen: `${window.screen.width}x${window.screen.height}x${window.screen.colorDepth}`,
      availScreen: `${window.screen.availWidth}x${window.screen.availHeight}`,

      // ูุนูููุงุช ุงููุชุตูุญ
      userAgent: navigator.userAgent,
      language: navigator.language,
      languages: navigator.languages ? navigator.languages.join(',') : '',
      platform: navigator.platform,
      cookieEnabled: navigator.cookieEnabled,
      doNotTrack: navigator.doNotTrack,

      // ูุนูููุงุช ุงููุธุงู
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      timezoneOffset: new Date().getTimezoneOffset(),

      // ูุนูููุงุช ุฅุถุงููุฉ ููุฃูุงู
      hardwareConcurrency: navigator.hardwareConcurrency || 0,
      maxTouchPoints: navigator.maxTouchPoints || 0,

      // ูุนูููุงุช ุงูุฐุงูุฑุฉ (ุฅุฐุง ูุงูุช ูุชุงุญุฉ)
      deviceMemory: navigator.deviceMemory || 0,

      // ูุนูููุงุช ุงูุดุจูุฉ (ุฅุฐุง ูุงูุช ูุชุงุญุฉ) - ุจุฏูู ุงูููู ุงููุชุบูุฑุฉ
      connection: navigator.connection
        ? {
            effectiveType: navigator.connection.effectiveType,
          }
        : null,
    };

    // ุฅุถุงูุฉ WebGL fingerprint
    let webglFingerprint = '';
    try {
      const gl =
        canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (gl) {
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          webglFingerprint =
            gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) +
            gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        }
      }
    } catch (e) {
      webglFingerprint = 'webgl_error';
    }

    // ุฏูุฌ ุฌููุน ุงููุนูููุงุช
    const combined =
      canvasFingerprint + JSON.stringify(deviceInfo) + webglFingerprint;

    // ุฅูุดุงุก hash ูุญุณู ุจุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ ุฃูุซุฑ ุชุนููุฏุงู
    let hash = 0;
    let hash2 = 0;

    for (let i = 0; i < combined.length; i++) {
      const char = combined.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash = hash & hash; // ุชุญููู ุฅูู 32bit integer

      // hash ุซุงููู ูููุฒูุฏ ูู ุงูุชุนููุฏ
      hash2 = (hash2 << 3) - hash2 + char;
      hash2 = hash2 & hash2;
    }

    // ุฏูุฌ ุงูู hashes ุจุฏูู timestamp ูุชุบูุฑ
    const finalHash = Math.abs(hash) + Math.abs(hash2);
    const deviceId = 'device_' + finalHash.toString(36);

    // ุญูุธ ูุนุฑู ุงูุฌูุงุฒ ุจุดูู ุฏุงุฆู
    localStorage.setItem('persistent_device_id', deviceId);

    console.log(
      '๐ ุชู ุฅูุดุงุก ูุนุฑู ุฌูุงุฒ ุฌุฏูุฏ:',
      deviceId.substring(0, 8) + '...'
    );
    return deviceId;
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅูุดุงุก ูุนุฑู ุงูุฌูุงุฒ:', error);
    // fallback ุฅูู ุทุฑููุฉ ุจุณูุทุฉ ูุน ุญูุธ ุฏุงุฆู
    const fallbackId = 'fallback_' + Math.random().toString(36).substr(2, 12);
    localStorage.setItem('persistent_device_id', fallbackId);
    return fallbackId;
  }
};

// ุฅุนุงุฏุฉ ุชุนููู ูุนุฑู ุงูุฌูุงุฒ (ููุงุณุชุฎุฏุงู ูู ุญุงูุงุช ุฎุงุตุฉ)
export const resetDeviceId = () => {
  try {
    localStorage.removeItem('persistent_device_id');
    console.log('๐ ุชู ุฅุนุงุฏุฉ ุชุนููู ูุนุฑู ุงูุฌูุงุฒ');
    return generateDeviceId(); // ุณูุชู ุฅูุดุงุก ูุนุฑู ุฌุฏูุฏ
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅุนุงุฏุฉ ุชุนููู ูุนุฑู ุงูุฌูุงุฒ:', error);
    return null;
  }
};
