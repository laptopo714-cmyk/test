# دليل إدارة الأجهزة - نظام معرف الجهاز الثابت

## نظرة عامة

تم تطوير نظام معرف الجهاز الثابت لحل مشكلة تسجيل الخروج التلقائي عند تحديث الصفحة، مع الحفاظ على أمان النظام وضمان استخدام كل رمز وصول على جهاز واحد فقط.

## كيفية عمل النظام

### 1. إنشاء معرف الجهاز

```javascript
// الدالة الجديدة تتحقق أولاً من وجود معرف محفوظ
const deviceId = generateDeviceId();

// إذا وُجد معرف محفوظ، يتم استخدامه
// إذا لم يوجد، يتم إنشاء معرف جديد وحفظه
```

### 2. حفظ المعرف

- يتم حفظ معرف الجهاز في `localStorage` تحت مفتاح `persistent_device_id`
- هذا المعرف لا يتغير عند تحديث الصفحة أو إعادة فتح المتصفح
- يبقى المعرف ثابتاً حتى يتم حذفه يدوياً أو إعادة تعيينه

### 3. التحقق من الجلسة

```javascript
// النظام يتحقق من تطابق معرف الجهاز المحفوظ مع الحالي
const savedDeviceId = localStorage.getItem('persistent_device_id');
const currentDeviceId = generateDeviceId();

if (savedDeviceId === currentDeviceId) {
  // الجهاز صحيح - السماح بالوصول
} else {
  // جهاز مختلف - منع الوصول
}
```

## الميزات الجديدة

### 1. الثبات عند تحديث الصفحة

- لن يتم تسجيل خروج الطلاب عند تحديث الصفحة
- معرف الجهاز يبقى ثابتاً عبر جلسات المتصفح

### 2. الأمان المحسن

- لا يزال النظام يمنع استخدام رمز الوصول على أجهزة متعددة
- تسجيل محاولات الوصول المشبوهة
- إشعارات أمنية للإدارة

### 3. إدارة مرنة

- إمكانية إعادة تعيين معرف الجهاز من الإدارة
- رسائل خطأ واضحة ومفيدة
- تشخيص مفصل للمشاكل

## دوال النظام الجديد

### `generateDeviceId()`

```javascript
// إنشاء أو استرجاع معرف الجهاز الثابت
const deviceId = generateDeviceId();
```

### `resetDeviceId()`

```javascript
// إعادة تعيين معرف الجهاز (للاستخدام الإداري)
const newDeviceId = resetDeviceId();
```

### `validateActiveSession()`

```javascript
// التحقق من صحة الجلسة النشطة
const result = await validateActiveSession(studentId, sessionToken, deviceId);
```

## حالات الاستخدام

### 1. تسجيل دخول جديد

1. يتم إنشاء معرف جهاز جديد (إذا لم يوجد)
2. يتم حفظ المعرف في قاعدة البيانات
3. يتم حفظ المعرف محلياً في `localStorage`

### 2. تحديث الصفحة

1. يتم استرجاع المعرف المحفوظ من `localStorage`
2. يتم مقارنته مع المعرف في قاعدة البيانات
3. إذا تطابقا، يتم السماح بالوصول

### 3. جهاز جديد

1. يتم إنشاء معرف جديد مختلف
2. لا يتطابق مع المعرف المحفوظ في قاعدة البيانات
3. يتم منع الوصول وعرض رسالة خطأ

### 4. إعادة تعيين من الإدارة

1. الإدارة تطلب إعادة تعيين الجهاز
2. يتم حذف المعرف من قاعدة البيانات
3. يتم إرسال إشارة للطالب لحذف المعرف المحلي
4. يمكن للطالب تسجيل الدخول من جهاز جديد

## استكشاف الأخطاء

### مشكلة: الطالب لا يزال يسجل خروج عند التحديث

**الحل:**

1. تحقق من وجود `persistent_device_id` في `localStorage`
2. تحقق من أن `generateDeviceId()` تعيد نفس القيمة
3. تحقق من logs المتصفح للأخطاء

### مشكلة: لا يمكن للطالب تسجيل الدخول من جهاز جديد

**الحل:**

1. استخدم دالة إعادة تعيين الجهاز من لوحة الإدارة
2. أو احذف `persistent_device_id` من `localStorage` يدوياً

### مشكلة: رسائل خطأ غير واضحة

**الحل:**

1. تحقق من logs المتصفح للتفاصيل
2. استخدم أدوات التشخيص المدمجة في النظام

## أفضل الممارسات

### للمطورين

1. لا تحذف `persistent_device_id` إلا عند الضرورة
2. استخدم دوال النظام المخصصة لإدارة معرفات الأجهزة
3. راقب logs النظام لاكتشاف المشاكل مبكراً

### للإدارة

1. استخدم وظيفة إعادة تعيين الجهاز بدلاً من حذف الحساب
2. راقب تقارير الأمان للنشاط المشبوه
3. تواصل مع الطلاب قبل إعادة تعيين أجهزتهم

## الأمان والخصوصية

### البيانات المحفوظة

- معرف الجهاز: hash مشفر لا يحتوي على معلومات شخصية
- لا يتم حفظ معلومات حساسة في `localStorage`
- جميع البيانات مشفرة ومحمية

### الحماية من التلاعب

- معرف الجهاز معقد ويصعب تقليده
- التحقق من سلامة البيانات المحفوظة
- تسجيل محاولات التلاعب والوصول غير المصرح

### الامتثال للخصوصية

- لا يتم جمع معلومات شخصية إضافية
- البيانات المحفوظة محلياً فقط لأغراض المصادقة
- يمكن للمستخدم حذف البيانات في أي وقت
